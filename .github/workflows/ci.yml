name: CI

permissions:
  contents: read

on:
  push:
  pull_request:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # Fijado a commit para seguridad de la cadena de suministro
        with:
          fetch-depth: 0
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      - name: Install system packages (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc g++ golang-go ruby-full rustc default-jdk clang llvm
      - name: Install system packages (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          brew update
          brew install gcc go ruby rust openjdk llvm
      - name: Install system packages (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install -y --no-progress mingw golang ruby rust openjdk llvm
      - name: Install dependencies
        uses: ./.github/actions/install
        with:
          extra: "sphinx sphinx-rtd-theme pytest-cov codecov pyright"
      - name: Verify extra packages
        shell: bash
        run: |
          python - <<'PY'
          import importlib
          for pkg in ["sphinx", "pyright"]:
              importlib.import_module(pkg.replace('-', '_'))
          PY
      - name: Seguridad de dependencias
        shell: bash
        run: |
          pip install safety
          safety check --full-report
      - name: Scan for secrets
        uses: gitleaks/gitleaks-action@dcedce43c6f43de0b836d1fe38946645c9c638dc # v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Run linters
        if: runner.os != 'Windows'
        shell: bash
        run: make lint
      - name: Run linters (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ./make.bat lint
      - name: Run type checks
        if: runner.os != 'Windows'
        shell: bash
        run: make typecheck  # Ejecuta mypy y pyright
      - name: Run type checks (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ./make.bat typecheck  # Ejecuta mypy y pyright
      - name: Validate changelog
        shell: bash
        run: python scripts/check_changelog.py
      - name: Run tests
        shell: bash
        run: |
          if [ -d tests ]; then
            pytest tests src/tests --cov=src --cov-report=xml \
              --cov-report=term-missing --cov-fail-under=95 -m "not windows"
            pytest tests src/tests -m windows
          else
            pytest src/tests --cov=src --cov-report=xml \
              --cov-report=term-missing --cov-fail-under=95 -m "not windows"
            pytest src/tests -m windows
          fi
      - name: Run LLVM examples
        if: runner.os == 'Linux'
        shell: bash
        run: |
          PYTHONPATH=src python scripts/test_llvm_examples.py
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@fdcc8476540edceab3de004e990f80d881c6cc00 # v5
        with:
          files: coverage.xml
      - name: Build docs
        shell: bash
        run: sphinx-build -b html frontend/docs frontend/build/html
      - name: Check doc links
        shell: bash
        run: sphinx-build -b linkcheck frontend/docs frontend/build/linkcheck

  benchmarks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # Fijado a commit para seguridad de la cadena de suministro
        with:
          fetch-depth: 0
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc g++ golang-go ruby-full rustc default-jdk
      - name: Install dependencies
        uses: ./.github/actions/install
        with:
          extra: "sphinx sphinx-rtd-theme pytest-cov codecov pyright"
      - name: Verify extra packages
        shell: bash
        run: |
          python - <<'PY'
          import importlib
          for pkg in ["sphinx", "pyright"]:
              importlib.import_module(pkg.replace('-', '_'))
          PY
      - name: Compare benchmarks
        run: |
          python scripts/benchmarks/compare_releases.py \
            --output benchmarks_compare.json \
            --max-regression 10
      - name: Upload benchmark results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: benchmarks_compare
          path: benchmarks_compare.json
      - name: Publicar resumen
        run: |
          python - <<'PY'
          import json, os

          data = json.load(open('benchmarks_compare.json'))
          lines = [
              "### Resultados de benchmarks",
              "",
              "| Backend | Δ Tiempo (s) | Δ Memoria (kB) |",
              "| --- | --- | --- |",
          ]
          for d in data:
              dt = d["diff_time"]
              dm = d["diff_memory_kb"]
              dt_str = f"{dt:+.4f}" if dt is not None else "N/A"
              dm_str = f"{dm:+d}" if dm is not None else "N/A"
              lines.append(f"| {d['backend']} | {dt_str} | {dm_str} |")

          with open(os.environ["GITHUB_STEP_SUMMARY"], "a") as fh:
              fh.write("\n".join(lines))
          PY
